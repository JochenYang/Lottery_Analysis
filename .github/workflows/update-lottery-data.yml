name: æ›´æ–°å½©ç¥¨æ•°æ®å’Œåˆ†æžæŠ¥å‘Š

on:
  push:
    branches: [ main ]  # æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main ]  # PRåˆå¹¶åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
    types: [ closed ]   # åªåœ¨PRå…³é—­æ—¶è§¦å‘
  schedule:
    # æ¯å¤©æ™šä¸Š21:45 (UTC+8) è¿è¡Œï¼Œå¯¹åº” 13:45 UTC
    - cron: '45 13 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘


jobs:
  update-lottery-data:
    runs-on: ubuntu-latest

    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ç¼“å­˜pipä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy matplotlib seaborn beautifulsoup4 hjson DrissionPage
        
        # å®‰è£…Chromeæµè§ˆå™¨ï¼ˆDrissionPageéœ€è¦ï¼‰
        # echo "å®‰è£…Chromeæµè§ˆå™¨..."
        # wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        # echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        # sudo apt-get update
        # sudo apt-get install -y google-chrome-stable
        
        # # éªŒè¯Chromeå®‰è£…
        # google-chrome --version
        
        # # è®¾ç½®æ˜¾ç¤ºçŽ¯å¢ƒå˜é‡ï¼ˆæ— å¤´æ¨¡å¼ï¼‰
        # export DISPLAY=:99
        # echo "Chromeæµè§ˆå™¨å®‰è£…å®Œæˆ"
        
    - name: è¿è¡Œå½©ç¥¨æ•°æ®åˆ†æž
      run: |
        echo "å¼€å§‹è¿è¡Œå½©ç¥¨æ•°æ®åˆ†æž..."
        python main.py
        exit_code=$?
        echo "åˆ†æžå®Œæˆï¼Œé€€å‡ºç : $exit_code"
        
        # ä¸ç®¡æˆåŠŸå¤±è´¥éƒ½ç»§ç»­åˆ°ä¸‹ä¸€æ­¥ï¼Œè®©gitå˜æ›´æ£€æŸ¥æ¥å†³å®šæ˜¯å¦éœ€è¦æäº¤
        # è¿™æ ·å¯ä»¥ç¡®ä¿ï¼š
        # 1. åªæœ‰çœŸæ­£æœ‰æ•°æ®æ›´æ–°æ—¶æ‰ä¼šæäº¤ï¼ˆé€šè¿‡git diffæ£€æŸ¥ï¼‰
        # 2. å³ä½¿éƒ¨åˆ†åˆ†æžå¤±è´¥ï¼ŒæˆåŠŸçš„éƒ¨åˆ†ä»èƒ½æäº¤
        # 3. é¿å…å› ä¸ºæ—§æ–‡ä»¶å­˜åœ¨è€Œè¯¯åˆ¤ä¸ºæˆåŠŸ
        echo "ç»§ç»­åˆ°æ–‡ä»¶å˜æ›´æ£€æŸ¥æ­¥éª¤..."
        
    - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
      id: git-check
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        if git diff --exit-code data/ reports/ pics/ README.md > /dev/null 2>&1; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "å˜æ›´çš„æ–‡ä»¶:"
          git diff --name-only data/ reports/ pics/ README.md || true
        fi
        
    - name: æäº¤æ›´æ–°
      if: (steps.git-check.outputs.changed == 'true' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')) || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
      run: |
        echo "å‡†å¤‡æäº¤æ–‡ä»¶å˜æ›´..."
        git config --local user.email "snjyor@gmail.com"
        git config --local user.name "snjyor"
        
        # æ£€æŸ¥å¹¶æ·»åŠ å­˜åœ¨çš„æ–‡ä»¶
        [ -d "data" ] && git add data/ || echo "dataç›®å½•ä¸å­˜åœ¨"
        [ -d "reports" ] && git add reports/ || echo "reportsç›®å½•ä¸å­˜åœ¨"  
        [ -d "pics" ] && git add pics/ || echo "picsç›®å½•ä¸å­˜åœ¨"
        [ -f "README.md" ] && git add README.md || echo "README.mdæ–‡ä»¶ä¸å­˜åœ¨"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«æ·»åŠ 
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
          exit 0
        fi
        
        # æäº¤å˜æ›´
        commit_message="ðŸŽ¯ æ›´æ–°å½©ç¥¨æ•°æ®å’Œåˆ†æžæŠ¥å‘Š - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        git commit -m "$commit_message"
        git push
        echo "æ–‡ä»¶æäº¤æˆåŠŸ"
        
    - name: åˆ›å»ºé‡å¤§æ›´æ–°çš„å‘å¸ƒç‰ˆæœ¬
      if: steps.git-check.outputs.changed == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "å‡†å¤‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬..."
        # èŽ·å–å½“å‰æ—¥æœŸä½œä¸ºtag (ä½¿ç”¨UTC+8æ—¶åŒº)
        TAG_NAME="$(TZ='Asia/Shanghai' date +'%Y%m%d')"

        # å¼ºåˆ¶åˆ é™¤å·²å­˜åœ¨çš„tagï¼Œç¡®ä¿å¹‚ç­‰æ€§
        echo "æ­£åœ¨åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ ‡ç­¾: $TAG_NAME"
        git push --delete origin $TAG_NAME 2>/dev/null || echo "è¿œç¨‹æ ‡ç­¾ $TAG_NAME ä¸å­˜åœ¨æˆ–åˆ é™¤å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œã€‚"
        git tag -d $TAG_NAME 2>/dev/null || echo "æœ¬åœ°æ ‡ç­¾ $TAG_NAME ä¸å­˜åœ¨æˆ–åˆ é™¤å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œã€‚"

        # åˆ›å»ºæ–°çš„tagå’Œrelease
        echo "æ­£åœ¨åˆ›å»ºæ–°æ ‡ç­¾: $TAG_NAME"
        git tag $TAG_NAME
        git push origin $TAG_NAME

        # åˆ›å»ºrelease notes
        cat > release_notes.md << EOF
        ## ðŸŽ¯ å½©ç¥¨æ•°æ®æ›´æ–° - $(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥') (UTC+8)

        ### ðŸ“Š æœ¬æ¬¡æ›´æ–°å†…å®¹
        - æŠ“å–æœ€æ–°åŒè‰²çƒå¼€å¥–æ•°æ®
        - æ›´æ–°ç»Ÿè®¡åˆ†æžå›¾è¡¨
        - åˆ·æ–°å·ç é¢‘çŽ‡åˆ†æž
        - æ›´æ–°åˆ†æžæŠ¥å‘Šæ–‡æ¡£

        ### ðŸ“ æ›´æ–°æ–‡ä»¶
        **åŒè‰²çƒæ•°æ®ï¼š**
        - \`data/lottery_data.json\` - åŒè‰²çƒå¼€å¥–æ•°æ®

        ### âš ï¸ å…è´£å£°æ˜Ž
        æœ¬æ•°æ®ä»…ä¾›å­¦ä¹ å’Œç»Ÿè®¡åˆ†æžä½¿ç”¨ï¼Œå½©ç¥¨å¼€å¥–å®Œå…¨éšæœºï¼Œè¯·ç†æ€§è´­å½©ã€‚
        EOF

        # å‡†å¤‡è¦ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆåªä¸Šä¼ å­˜åœ¨çš„æ–‡ä»¶ï¼‰
        upload_files=""
        [ -f "data/lottery_data.json" ] && upload_files="$upload_files data/lottery_data.json"

        # ä½¿ç”¨GitHub CLIåˆ›å»ºreleaseï¼ˆåªä¸Šä¼ å­˜åœ¨çš„æ–‡ä»¶ï¼‰
        if [ -n "$upload_files" ]; then
          gh release create $TAG_NAME \
            --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
            --notes-file release_notes.md \
            $upload_files
          echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼ŒåŒ…å«æ–‡ä»¶: $upload_files"
        else
          gh release create $TAG_NAME \
            --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
            --notes-file release_notes.md
          echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼Œä½†æ²¡æœ‰æ•°æ®æ–‡ä»¶å¯ä¸Šä¼ "
        fi
        
    - name: è¾“å‡ºç»“æžœ
      run: |
        if [ "${{ steps.git-check.outputs.changed }}" == "true" ]; then
          echo "âœ… å½©ç¥¨æ•°æ®å·²æ›´æ–°å¹¶æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
          
          # æ˜¾ç¤ºæ›´æ–°çš„æ–‡ä»¶
          echo "ðŸ“ æ›´æ–°çš„æ–‡ä»¶:"
          [ -f "data/lottery_data.json" ] && echo "  âœ“ åŒè‰²çƒå¼€å¥–æ•°æ®"
        else
          echo "â„¹ï¸ å½©ç¥¨æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        fi
