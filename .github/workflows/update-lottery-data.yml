name: æ›´æ–°å½©ç¥¨æ•°æ®å’Œåˆ†ææŠ¥å‘Š

on:
  schedule:
    # æ¯å¤©æ™šä¸Š21:45 (UTC+8) è¿è¡Œï¼Œå¯¹åº” 13:45 UTC
    - cron: "45 13 * * *"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-lottery-data:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ç¼“å­˜pipä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas numpy matplotlib seaborn beautifulsoup4 hjson DrissionPage

          # å®‰è£…Chromeæµè§ˆå™¨ï¼ˆDrissionPageéœ€è¦ï¼‰
          # echo "å®‰è£…Chromeæµè§ˆå™¨..."
          # wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          # echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          # sudo apt-get update
          # sudo apt-get install -y google-chrome-stable

          # # éªŒè¯Chromeå®‰è£…
          # google-chrome --version

          # # è®¾ç½®æ˜¾ç¤ºç¯å¢ƒå˜é‡ï¼ˆæ— å¤´æ¨¡å¼ï¼‰
          # export DISPLAY=:99
          # echo "Chromeæµè§ˆå™¨å®‰è£…å®Œæˆ"

      - name: è¿è¡Œå½©ç¥¨æ•°æ®åˆ†æ
        run: |
          echo "å¼€å§‹è¿è¡Œå½©ç¥¨æ•°æ®åˆ†æ..."

          # æ·»åŠ æ‰§è¡Œå‰çš„ç¯å¢ƒæ£€æŸ¥
          echo "ğŸ“ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ğŸ“‹ æ‰§è¡Œå‰æ–‡ä»¶çŠ¶æ€æ£€æŸ¥:"
          [ -f "README.md" ] && echo "  âœ“ README.md å­˜åœ¨" || echo "  âŒ README.md ä¸å­˜åœ¨"
          [ -f "main.py" ] && echo "  âœ“ main.py å­˜åœ¨" || echo "  âŒ main.py ä¸å­˜åœ¨"
          [ -d "scripts" ] && echo "  âœ“ scriptsç›®å½• å­˜åœ¨" || echo "  âŒ scriptsç›®å½• ä¸å­˜åœ¨"

          # æ£€æŸ¥README.mdä¸­çš„æ¨èå·ç æ ‡è®°
          if [ -f "README.md" ]; then
            echo "ğŸ” æ£€æŸ¥README.mdä¸­çš„æ ‡è®°:"
            grep -n "RECOMMENDATIONS_START" README.md || echo "  âš ï¸ æœªæ‰¾åˆ°RECOMMENDATIONS_STARTæ ‡è®°"
            grep -n "RECOMMENDATIONS_END" README.md || echo "  âš ï¸ æœªæ‰¾åˆ°RECOMMENDATIONS_ENDæ ‡è®°"
          fi

          echo "ğŸš€ å¼€å§‹æ‰§è¡ŒPythonåˆ†æè„šæœ¬..."
          python main.py
          exit_code=$?
          echo "åˆ†æå®Œæˆï¼Œé€€å‡ºç : $exit_code"

          # æ·»åŠ æ‰§è¡Œåçš„æ–‡ä»¶çŠ¶æ€æ£€æŸ¥
          echo "ğŸ“‹ æ‰§è¡Œåæ–‡ä»¶çŠ¶æ€æ£€æŸ¥:"
          [ -f "README.md" ] && echo "  âœ“ README.md å­˜åœ¨" || echo "  âŒ README.md ä¸å­˜åœ¨"
          [ -f "data/lottery_data.json" ] && echo "  âœ“ lottery_data.json å­˜åœ¨" || echo "  âŒ lottery_data.json ä¸å­˜åœ¨"
          [ -f "reports/analysis_report.md" ] && echo "  âœ“ analysis_report.md å­˜åœ¨" || echo "  âŒ analysis_report.md ä¸å­˜åœ¨"

          # æ£€æŸ¥README.mdçš„æœ€åä¿®æ”¹æ—¶é—´
          if [ -f "README.md" ]; then
            echo "ğŸ“… README.md æœ€åä¿®æ”¹æ—¶é—´: $(stat -c %y README.md 2>/dev/null || stat -f %Sm README.md 2>/dev/null || echo 'æ— æ³•è·å–')"
            echo "ğŸ” README.md æ¨èå·ç éƒ¨åˆ†é¢„è§ˆ:"
            grep -A 5 -B 1 "åŒè‰²çƒæ¨è" README.md || echo "  âš ï¸ æœªæ‰¾åˆ°æ¨èå·ç å†…å®¹"
          fi

          # ä¸ç®¡æˆåŠŸå¤±è´¥éƒ½ç»§ç»­åˆ°ä¸‹ä¸€æ­¥ï¼Œè®©gitå˜æ›´æ£€æŸ¥æ¥å†³å®šæ˜¯å¦éœ€è¦æäº¤
          # è¿™æ ·å¯ä»¥ç¡®ä¿ï¼š
          # 1. åªæœ‰çœŸæ­£æœ‰æ•°æ®æ›´æ–°æ—¶æ‰ä¼šæäº¤ï¼ˆé€šè¿‡git diffæ£€æŸ¥ï¼‰
          # 2. å³ä½¿éƒ¨åˆ†åˆ†æå¤±è´¥ï¼ŒæˆåŠŸçš„éƒ¨åˆ†ä»èƒ½æäº¤
          # 3. é¿å…å› ä¸ºæ—§æ–‡ä»¶å­˜åœ¨è€Œè¯¯åˆ¤ä¸ºæˆåŠŸ
          echo "ç»§ç»­åˆ°æ–‡ä»¶å˜æ›´æ£€æŸ¥æ­¥éª¤..."

      - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: git-check
        run: |
          echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."

          # æ·»åŠ è¯¦ç»†çš„æ–‡ä»¶çŠ¶æ€æ£€æŸ¥
          echo "ğŸ“‹ è¯¦ç»†æ–‡ä»¶çŠ¶æ€æ£€æŸ¥:"
          echo "  ğŸ“ dataç›®å½•:"
          [ -d "data" ] && ls -la data/ || echo "    âŒ dataç›®å½•ä¸å­˜åœ¨"
          echo "  ğŸ“ reportsç›®å½•:"
          [ -d "reports" ] && ls -la reports/ || echo "    âŒ reportsç›®å½•ä¸å­˜åœ¨"
          echo "  ğŸ“ picsç›®å½•:"
          [ -d "pics" ] && ls -la pics/ || echo "    âŒ picsç›®å½•ä¸å­˜åœ¨"
          echo "  ğŸ“„ README.md:"
          [ -f "README.md" ] && ls -la README.md || echo "    âŒ README.mdä¸å­˜åœ¨"

          # æ£€æŸ¥æ¯ä¸ªæ–‡ä»¶/ç›®å½•çš„gitçŠ¶æ€
          echo "ğŸ” GitçŠ¶æ€æ£€æŸ¥:"
          echo "  dataç›®å½•å˜æ›´:"
          git diff --name-only data/ || echo "    æ— å˜æ›´"
          echo "  reportsç›®å½•å˜æ›´:"
          git diff --name-only reports/ || echo "    æ— å˜æ›´"
          echo "  picsç›®å½•å˜æ›´:"
          git diff --name-only pics/ || echo "    æ— å˜æ›´"
          echo "  README.mdå˜æ›´:"
          git diff --name-only README.md || echo "    æ— å˜æ›´"

          # ç‰¹åˆ«æ£€æŸ¥README.mdçš„å†…å®¹å˜æ›´
          if [ -f "README.md" ]; then
            echo "ğŸ“ README.mdå†…å®¹å˜æ›´è¯¦æƒ…:"
            if git diff --quiet README.md; then
              echo "    âœ… README.mdæ— å˜æ›´"
            else
              echo "    ğŸ”„ README.mdæœ‰å˜æ›´ï¼Œå˜æ›´å†…å®¹:"
              git diff README.md | head -20 || true
            fi
          fi

          # ä¿æŒåŸæœ‰çš„æ•´ä½“æ£€æŸ¥é€»è¾‘
          if git diff --exit-code data/ reports/ pics/ README.md > /dev/null 2>&1; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "å˜æ›´çš„æ–‡ä»¶:"
            git diff --name-only data/ reports/ pics/ README.md || true
          fi

      - name: æäº¤æ›´æ–°
        if: steps.git-check.outputs.changed == 'true'
        run: |
          echo "å‡†å¤‡æäº¤æ–‡ä»¶å˜æ›´..."
          git config --local user.email "dayantv666@gmail.com"
          git config --local user.name "Jochen"

          # æ·»åŠ æäº¤å‰çš„è¯¦ç»†éªŒè¯
          echo "ğŸ“‹ æäº¤å‰æ–‡ä»¶éªŒè¯:"

          # æ£€æŸ¥å¹¶æ·»åŠ å­˜åœ¨çš„æ–‡ä»¶
          if [ -d "data" ]; then
            git add data/
            echo "  âœ… dataç›®å½•å·²æ·»åŠ åˆ°æš‚å­˜åŒº"
          else
            echo "  âŒ dataç›®å½•ä¸å­˜åœ¨"
          fi

          if [ -d "reports" ]; then
            git add reports/
            echo "  âœ… reportsç›®å½•å·²æ·»åŠ åˆ°æš‚å­˜åŒº"
          else
            echo "  âŒ reportsç›®å½•ä¸å­˜åœ¨"
          fi

          if [ -d "pics" ]; then
            git add pics/
            echo "  âœ… picsç›®å½•å·²æ·»åŠ åˆ°æš‚å­˜åŒº"
          else
            echo "  âŒ picsç›®å½•ä¸å­˜åœ¨"
          fi

          # ç‰¹åˆ«éªŒè¯README.md
          if [ -f "README.md" ]; then
            echo "ğŸ“ README.mdç‰¹æ®ŠéªŒè¯:"
            echo "  ğŸ“… æ–‡ä»¶å¤§å°: $(wc -c < README.md) å­—èŠ‚"
            echo "  ğŸ“… è¡Œæ•°: $(wc -l < README.md) è¡Œ"
            echo "  ğŸ” æ¨èå·ç æ ‡è®°æ£€æŸ¥:"
            grep -c "RECOMMENDATIONS_START" README.md && echo "    âœ… å¼€å§‹æ ‡è®°å­˜åœ¨" || echo "    âŒ å¼€å§‹æ ‡è®°ç¼ºå¤±"
            grep -c "RECOMMENDATIONS_END" README.md && echo "    âœ… ç»“æŸæ ‡è®°å­˜åœ¨" || echo "    âŒ ç»“æŸæ ‡è®°ç¼ºå¤±"
            echo "  ğŸ“ æœ€æ–°æ¨èå†…å®¹é¢„è§ˆ:"
            grep -A 3 "æ›´æ–°æ—¶é—´:" README.md || echo "    âš ï¸ æœªæ‰¾åˆ°æ›´æ–°æ—¶é—´"

            git add README.md
            echo "  âœ… README.mdå·²æ·»åŠ åˆ°æš‚å­˜åŒº"
          else
            echo "  âŒ README.mdæ–‡ä»¶ä¸å­˜åœ¨"
          fi

          # æ˜¾ç¤ºæš‚å­˜åŒºçŠ¶æ€
          echo "ğŸ“‹ æš‚å­˜åŒºçŠ¶æ€:"
          git diff --cached --name-only || echo "  æš‚å­˜åŒºä¸ºç©º"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«æ·»åŠ 
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
            exit 0
          fi

          # æäº¤å˜æ›´
          commit_message="ğŸ¯ æ›´æ–°å½©ç¥¨æ•°æ®å’Œåˆ†ææŠ¥å‘Š - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
          git commit -m "$commit_message"
          git push
          echo "æ–‡ä»¶æäº¤æˆåŠŸ"

      - name: åˆ›å»ºé‡å¤§æ›´æ–°çš„å‘å¸ƒç‰ˆæœ¬
        if: steps.git-check.outputs.changed == 'true' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "å‡†å¤‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬..."
          # è·å–å½“å‰æ—¥æœŸä½œä¸ºtag (ä½¿ç”¨UTC+8æ—¶åŒº)
          TAG_NAME="$(TZ='Asia/Shanghai' date +'%Y%m%d')"

          # å¼ºåˆ¶åˆ é™¤å·²å­˜åœ¨çš„tagï¼Œç¡®ä¿å¹‚ç­‰æ€§
          echo "æ­£åœ¨åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ ‡ç­¾: $TAG_NAME"
          git push --delete origin $TAG_NAME 2>/dev/null || echo "è¿œç¨‹æ ‡ç­¾ $TAG_NAME ä¸å­˜åœ¨æˆ–åˆ é™¤å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œã€‚"
          git tag -d $TAG_NAME 2>/dev/null || echo "æœ¬åœ°æ ‡ç­¾ $TAG_NAME ä¸å­˜åœ¨æˆ–åˆ é™¤å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œã€‚"

          # åˆ›å»ºæ–°çš„tagå’Œrelease
          echo "æ­£åœ¨åˆ›å»ºæ–°æ ‡ç­¾: $TAG_NAME"
          git tag $TAG_NAME
          git push origin $TAG_NAME

          # åˆ›å»ºrelease notes
          cat > release_notes.md << EOF
          ## ğŸ¯ å½©ç¥¨æ•°æ®æ›´æ–° - $(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥') (UTC+8)

          ### ğŸ“Š æœ¬æ¬¡æ›´æ–°å†…å®¹
          - æŠ“å–æœ€æ–°åŒè‰²çƒå¼€å¥–æ•°æ®
          - æ›´æ–°ç»Ÿè®¡åˆ†æå›¾è¡¨
          - åˆ·æ–°å·ç é¢‘ç‡åˆ†æ
          - æ›´æ–°åˆ†ææŠ¥å‘Šæ–‡æ¡£

          ### ğŸ“ æ›´æ–°æ–‡ä»¶
          **åŒè‰²çƒæ•°æ®ï¼š**
          - \`data/lottery_data.json\` - åŒè‰²çƒå¼€å¥–æ•°æ®
          - \`README.md\` - é¡¹ç›®é¦–é¡µæ¨èå·ç 

          ### âš ï¸ å…è´£å£°æ˜
          æœ¬æ•°æ®ä»…ä¾›å­¦ä¹ å’Œç»Ÿè®¡åˆ†æä½¿ç”¨ï¼Œå½©ç¥¨å¼€å¥–å®Œå…¨éšæœºï¼Œè¯·ç†æ€§è´­å½©ã€‚
          EOF

          # å‡†å¤‡è¦ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆåªä¸Šä¼ å­˜åœ¨çš„æ–‡ä»¶ï¼‰
          upload_files=""
          [ -f "data/lottery_data.json" ] && upload_files="$upload_files data/lottery_data.json"

          # ä½¿ç”¨GitHub CLIåˆ›å»ºreleaseï¼ˆåªä¸Šä¼ å­˜åœ¨çš„æ–‡ä»¶ï¼‰
          if [ -n "$upload_files" ]; then
            gh release create $TAG_NAME \
              --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
              --notes-file release_notes.md \
              $upload_files
            echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼ŒåŒ…å«æ–‡ä»¶: $upload_files"
          else
            gh release create $TAG_NAME \
              --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
              --notes-file release_notes.md
            echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼Œä½†æ²¡æœ‰æ•°æ®æ–‡ä»¶å¯ä¸Šä¼ "
          fi

      - name: è¾“å‡ºç»“æœ
        run: |
          if [ "${{ steps.git-check.outputs.changed }}" == "true" ]; then
            echo "âœ… å½©ç¥¨æ•°æ®å·²æ›´æ–°å¹¶æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
            
            # æ˜¾ç¤ºæ›´æ–°çš„æ–‡ä»¶
            echo "ğŸ“ æ›´æ–°çš„æ–‡ä»¶:"
            [ -f "data/lottery_data.json" ] && echo "  âœ“ åŒè‰²çƒå¼€å¥–æ•°æ®"
            [ -f "README.md" ] && echo "  âœ“ README.md"
          else
            echo "â„¹ï¸ å½©ç¥¨æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
          fi
